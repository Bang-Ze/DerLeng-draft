<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home page</title>
    <!-- icon -->
    <link rel="shortcut icon" href="./img/home/icon.png" type="image/x-icon" />
    <!-- style -->
    <link rel="stylesheet" href="../src/output.css" />
    <!-- animation -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <script
      src="https://kit.fontawesome.com/5ce14b4205.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body class="bg-background">
    <section class="">
      <div
        class="max-w-4xl mx-auto bg-white/95 backdrop-blur-lg rounded-3xl p-10 shadow-2xl"
      >
        <h1 class="text-center text-4xl font-bold mb-8 text-primary">
          🏞️ Place Creator
        </h1>
        <form id="placeForm" class="space-y-6">
          <div class="space-y-2">
            <label for="name" class="block text-gray-700 font-semibold text-lg"
              >Place Name *</label
            >
            <input
              type="text"
              id="name"
              name="name"
              value="ជីផាត់-ទេសចរណ៍ធម្មជាតិ- កោះកុង"
              required
              class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 focus:outline-none focus:border-indigo-500 focus:shadow-lg focus:shadow-indigo-200/50 hover:-translate-y-0.5"
            />
          </div>
          <div class="space-y-2">
            <label
              for="description"
              class="block text-gray-700 font-semibold text-lg"
              >Description *</label
            >
            <textarea
              id="description"
              name="description"
              required
              class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl text-base resize-y min-h-[120px] transition-all duration-300 focus:outline-none focus:border-indigo-500 focus:shadow-lg focus:shadow-indigo-200/50 hover:-translate-y-0.5"
            >
        ជាកោដើរលេងក្នុងព្រៃ ជិះទូកកាយ៉ាក់ ជិះកង់ឡើងភ្នំ និង មើលសត្វព្រៃ។</textarea
            >
          </div>
          <div class="space-y-2">
            <label
              for="openHours"
              class="block text-gray-700 font-semibold text-lg"
              >Opening Hours</label
            >
            <input
              type="text"
              id="openHours"
              name="openHours"
              value="Open 24h"
              class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 focus:outline-none focus:border-indigo-500 focus:shadow-lg focus:shadow-indigo-200/50 hover:-translate-y-0.5"
            />
          </div>
          <div class="space-y-2">
            <label
              for="entryFee"
              class="block text-gray-700 font-semibold text-lg"
              >Entry Fee ($)</label
            >
            <input
              type="number"
              id="entryFee"
              name="entryFee"
              value="0.00"
              step="0.01"
              min="0"
              class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 focus:outline-none focus:border-indigo-500 focus:shadow-lg focus:shadow-indigo-200/50 hover:-translate-y-0.5"
            />
          </div>
          <div class="space-y-2">
            <label
              for="location"
              class="block text-gray-700 font-semibold text-lg"
              >Location (lat,lng)</label
            >
            <input
              type="text"
              id="location"
              name="location"
              value="10.7131,103.2343"
              placeholder="10.7131,103.2343"
              class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 focus:outline-none focus:border-indigo-500 focus:shadow-lg focus:shadow-indigo-200/50 hover:-translate-y-0.5"
            />
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="space-y-2">
              <label
                for="latitude"
                class="block text-gray-700 font-semibold text-lg"
                >Latitude</label
              >
              <input
                type="text"
                id="latitude"
                name="latitude"
                value="00.00"
                class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 focus:outline-none focus:border-indigo-500 focus:shadow-lg focus:shadow-indigo-200/50 hover:-translate-y-0.5"
              />
            </div>
            <div class="space-y-2">
              <label
                for="longitude"
                class="block text-gray-700 font-semibold text-lg"
                >Longitude</label
              >
              <input
                type="text"
                id="longitude"
                name="longitude"
                value="00.00"
                class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 focus:outline-none focus:border-indigo-500 focus:shadow-lg focus:shadow-indigo-200/50 hover:-translate-y-0.5"
              />
            </div>
          </div>
          <div class="space-y-2">
            <label
              for="categoryName"
              class="block text-gray-700 font-semibold text-lg"
              >Category</label
            >
            <select
              id="categoryName"
              name="categoryName"
              class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 focus:outline-none focus:border-indigo-500 focus:shadow-lg focus:shadow-indigo-200/50 hover:-translate-y-0.5"
            >
              <option value="Phnom Penh">ភ្នំពេញ</option>
              <option value="Siem Reap">សៀមរាប</option>
              <option value="Kom pot">កំពត</option>
              <option value="Kep">កែប</option>
              <option value="Battambong">បាត់ដំបង</option>
              <option value="Sihanoukville">ព្រះសីហនុ</option>
              <option value="Koh kong">កោះកុង</option>
            </select>
          </div>
          <div class="space-y-2">
            <label class="block text-gray-700 font-semibold text-lg"
              >Images</label
            >
            <div class="file-upload relative overflow-hidden w-full">
              <input
                type="file"
                id="images"
                accept="image/*"
                multiple
                class="absolute left-[-9999px]"
              />
              <label
                for="images"
                class="cursor-pointer block p-8 border-3 border-dashed border-indigo-500 rounded-xl text-center bg-indigo-50/50 transition-all duration-300 hover:bg-indigo-100/70 hover:border-purple-600"
              >
                <div class="text-4xl mb-4">📁</div>
                <span class="text-lg font-medium text-gray-700"
                  >Click to select images or drag and drop</span
                >
                <div class="text-sm text-gray-500 mt-2">
                  Support multiple image files (JPG, PNG, GIF)
                </div>
              </label>
            </div>
            <div
              id="imagePreview"
              class="mt-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"
            ></div>
          </div>
          <button
            type="submit"
            class="w-full py-4 px-8 rounded-[10px] text-lg font-bold uppercase tracking-wider transition-all duration-300 hover:-translate-y-1 hover:shadow-xl hover:shadow-indigo-500/40 disabled:opacity-60 disabled:cursor-not-allowed disabled:hover:translate-y-0"
            id="submitBtn"
          >
            Create Place
          </button>
        </form>
        <div id="status" class="mt-6 p-4 rounded-xl font-medium hidden"></div>
      </div>
    </section>

    <script>
      const API_BASE = "https://tos-der.sokpheng.com/api/v1";
      let selectedFiles = [];

      const imageInput = document.getElementById("images");
      const imagePreview = document.getElementById("imagePreview");
      const form = document.getElementById("placeForm");
      const statusDiv = document.getElementById("status");
      const submitBtn = document.getElementById("submitBtn");

      // Handle file selection
      imageInput.addEventListener("change", function (e) {
        const files = Array.from(e.target.files);
        selectedFiles = files;
        displayImagePreviews();
      });

      function displayImagePreviews() {
        imagePreview.innerHTML = "";

        selectedFiles.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            const previewDiv = document.createElement("div");
            previewDiv.className =
              "relative rounded-xl overflow-hidden aspect-square shadow-lg";
            previewDiv.innerHTML = `
              <img src="${e.target.result}" alt="Preview ${
              index + 1
            }" class="w-full h-full object-cover">
              <button type="button" onclick="removeImage(${index})" class="absolute top-2 right-2 bg-red-500/80 hover:bg-red-600 text-white rounded-[10px] w-6 h-6 flex items-center justify-center text-sm font-bold transition-colors">×</button>
            `;
            imagePreview.appendChild(previewDiv);
          };
          reader.readAsDataURL(file);
        });
      }

      function removeImage(index) {
        selectedFiles.splice(index, 1);
        displayImagePreviews();
      }

      function showStatus(message, type) {
        statusDiv.innerHTML = message;
        statusDiv.className = `mt-6 p-4 rounded-xl font-medium ${getStatusClasses(
          type
        )}`;
        statusDiv.classList.remove("hidden");
      }

      function getStatusClasses(type) {
        switch (type) {
          case "success":
            return "bg-green-100 text-green-800 border border-green-300";
          case "error":
            return "bg-red-100 text-red-800 border border-red-300";
          case "loading":
            return "bg-blue-100 text-blue-800 border border-blue-300";
          default:
            return "bg-gray-100 text-gray-800 border border-gray-300";
        }
      }

      async function uploadImages() {
        if (selectedFiles.length === 0) {
          return [];
        }

        const formData = new FormData();
        selectedFiles.forEach((file) => {
          formData.append("files", file);
        });

        try {
          const response = await fetch(`${API_BASE}/upload/multiple`, {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            throw new Error(
              `Upload failed: ${response.status} ${response.statusText}`
            );
          }

          const result = await response.json();
          console.log("Upload response:", result);

          // Handle different possible response structures
          if (result.urls && Array.isArray(result.urls)) {
            return result.urls;
          } else if (result.data && Array.isArray(result.data.urls)) {
            return result.data.urls;
          } else if (Array.isArray(result)) {
            return result;
          } else if (result.files && Array.isArray(result.files)) {
            return result.files.map((f) => f.url || f.path || f.filename);
          } else if (result.images && Array.isArray(result.images)) {
            return result.images.map((img) => img.url || img.path || img);
          } else {
            console.warn("Unexpected upload response structure:", result);
            const possibleUrls = Object.values(result)
              .flat()
              .filter(
                (val) =>
                  typeof val === "string" &&
                  val.includes("tos-der.sokpheng.com/images/")
              );
            return possibleUrls.length > 0 ? possibleUrls : [];
          }
        } catch (error) {
          console.error("Image upload error:", error);
          throw new Error(`Image upload failed: ${error.message}`);
        }
      }

      async function createPlace(placeData) {
        try {
          const response = await fetch(`${API_BASE}/places`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(placeData),
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(
              `Place creation failed: ${response.status} ${response.statusText} - ${errorText}`
            );
          }

          const result = await response.json();
          console.log("Place creation response:", result);
          return result;
        } catch (error) {
          console.error("Place creation error:", error);
          throw error;
        }
      }

      form.addEventListener("submit", async function (e) {
        e.preventDefault();

        submitBtn.disabled = true;
        showStatus(
          '<div class="inline-block w-5 h-5 border-2 border-gray-300 border-t-blue-600 rounded-[10px] animate-spin mr-2"></div>Processing...',
          "loading"
        );

        try {
          // Step 1: Upload images if any
          let imageUrls = [];
          if (selectedFiles.length > 0) {
            showStatus(
              '<div class="inline-block w-5 h-5 border-2 border-gray-300 border-t-blue-600 rounded-[10px] animate-spin mr-2"></div>Uploading images...',
              "loading"
            );
            imageUrls = await uploadImages();
            console.log("Uploaded image URLs:", imageUrls);
          }

          const names = imageUrls.map((developer) => developer.uri);
          console.log("Uploaded image:", names);

          // Step 2: Prepare place data
          const formData = new FormData(form);
          const placeData = {
            name: formData.get("name"),
            description: formData.get("description"),
            openHours: formData.get("openHours"),
            entryFee: parseFloat(formData.get("entryFee")) || 0.0,
            imageUrls: names,
            location: formData.get("location"),
            latitude: formData.get("latitude"),
            longitude: formData.get("longitude"),
            categoryName: formData.get("categoryName"),
          };

          console.log("Sending place data:", placeData);

          // Step 3: Create place
          showStatus(
            '<div class="inline-block w-5 h-5 border-2 border-gray-300 border-t-blue-600 rounded-[10px] animate-spin mr-2"></div>Creating place...',
            "loading"
          );
          const result = await createPlace(placeData);

          showStatus(
            `✅ Place created successfully! ${
              imageUrls.length > 0
                ? `Uploaded ${imageUrls.length} image(s).`
                : "No images uploaded."
            }`,
            "success"
          );

          // Reset form
          form.reset();
          selectedFiles = [];
          imagePreview.innerHTML = "";

          // Restore default values
          document.getElementById("name").value =
            "ជីផាត់-ទេសចរណ៍ធម្មជាតិ- កោះកុង";
          document.getElementById("description").value =
            "ជាកោដើរលេងក្នុងព្រៃ ជិះទូកកាយ៉ាក់ ជិះកង់ឡើងភ្នំ និង មើលសត្វព្រៃ។";
          document.getElementById("openHours").value = "Open 24h";
          document.getElementById("entryFee").value = "0.00";
          document.getElementById("location").value = "10.7131,103.2343";
          document.getElementById("latitude").value = "00.00";
          document.getElementById("longitude").value = "00.00";
          document.getElementById("categoryName").value = "Phnom";
        } catch (error) {
          console.error("Operation failed:", error);
          showStatus(`❌ Error: ${error.message}`, "error");
        } finally {
          submitBtn.disabled = false;
        }
      });

      // Drag and drop functionality
      const fileUpload = document.querySelector(".file-upload");
      const fileLabel = fileUpload.querySelector("label");

      fileUpload.addEventListener("dragover", function (e) {
        e.preventDefault();
        fileLabel.classList.remove("bg-indigo-50/50");
        fileLabel.classList.add("bg-indigo-100/70", "border-purple-600");
      });

      fileUpload.addEventListener("dragleave", function (e) {
        e.preventDefault();
        fileLabel.classList.add("bg-indigo-50/50");
        fileLabel.classList.remove("bg-indigo-100/70", "border-purple-600");
      });

      fileUpload.addEventListener("drop", function (e) {
        e.preventDefault();
        fileLabel.classList.add("bg-indigo-50/50");
        fileLabel.classList.remove("bg-indigo-100/70", "border-purple-600");

        const files = Array.from(e.dataTransfer.files).filter((file) =>
          file.type.startsWith("image/")
        );
        if (files.length > 0) {
          selectedFiles = files;
          displayImagePreviews();
        }
      });
    </script>
  </body>
</html>
